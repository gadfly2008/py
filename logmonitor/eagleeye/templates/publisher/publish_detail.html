{% extends "publisher/index.html" %}
{% block content %}
<div class="top-div">
    <div class="search-box">
        <input type="hidden" id="customer_value" value="0">
        <input type="hidden" id="channel_value" value="0">
        <div class="search">
            <input id="customer" class="text" type="text"
                   value="客户查询" onfocus="searchFocusSet(this,'客户查询')" onblur="searchBlurSet(this,'客户查询')"
                   autocomplete="off" role="textbox" aria-autocomplete="list" aira-haspopup="true">
        </div>
        <div class="search">
            <input id="channel" class="text" type="text"
                   value="频道查询" onfocus="searchFocusSet(this,'频道查询')" onblur="searchBlurSet(this,'频道查询')"
                   autocomplete="off" role="textbox" aria-autocomplete="list" aira-haspopup="true">
        </div>
        <div class="search">
            <input type="text" id="beginDate" class="datepicker" value="{{ beginDate }}" readonly="true" name="beginDate"/>
        </div>
        <div class="search submit">
            <input type="image" src="/static/images/btn_submit.png" id="submit"/>
        </div>
    </div>
    <div class="clear"></div>
</div>
<div class="middle-div">
    <div id="charts">
        <br/>
        <div id="chart-publish-detail"></div>
    </div>
</div>
<div class="clear"></div>
<script type="text/javascript">
$(document).ready(function() {
    $('.datepicker').datepicker();

    $('div.search input.text').addClass('search_font_style');
    $('#customer').autocomplete({
          source: function(request, response) {
              $.ajax({
                 url: "/rcms/customers/",
                 dataType: "json",
                 data: {
                     name: request.term
                 },
                 success: function(data) {
                     response($.map(data.customers, function(item) {
                         return {
                             label: item.name,
                             value: item.customerId
                         }
                     }));
                 }
             });
          },
          minLength: 2,
          focus: function(event, ui) {
              $('#customer').val(ui.item.label);
              return false;
          },
          select: function(event, ui) {
              $('#customer').val(ui.item.label);
              $('#customer_value').val(ui.item.value);
              return false;
          },
          change: function(event, ui) {
              if (ui.item) {
                  $('#customer_value').val(ui.item.value);
              }
              else {
                  $('#customer_value').val("0");
              }
              return false;
          }
      });

    $('#channel').autocomplete({
           source: function(request, response) {
               $.ajax({
                  url: "/rcms/channels/",
                  dataType: "json",
                  data: {
                      name: request.term
                  },
                  success: function(data) {
                      response($.map(data.channels, function(item) {
                          return {
                              label: item.name,
                              value: item.channelId
                          }
                      }));
                  }
              });
           },
           minLength: 5,
           focus: function(event, ui) {
               $('#channel').val(ui.item.label);
               return false;
           },
           select: function(event, ui) {
               $('#channel').val(ui.item.label);
               $('#channel_value').val(ui.item.value);
               return false;
           },
           change: function(event, ui) {
               if (ui.item) {
                   $('#channel_value').val(ui.item.value);
               }
               else {
                   $('#channel_value').val("0");
               }
               return false;
           }
       });

    $('#submit').click(function() {
        var customerId = $('#customer_value').val();
        var channelId = $('#channel_value').val();
        var day = $('#beginDate').val();

        if (customerId == "0" && channelId == "0") {
            return;
        }
        FusionCharts._fallbackJSChartWhenNoFlash();
        var chart = new FusionCharts("/static/swf/Column3D.swf",
        "cpd", "100%", "500", "0", "1");
        var url = "/publisher/publishdetail/data/";
        url += "?beginDate="+day;
        url += "%26customerId="+customerId;
        url += "%26channelId="+channelId;
        chart.setJSONUrl(url);
        chart.render("chart-publish-detail");
    });
});
</script>
{% endblock %}