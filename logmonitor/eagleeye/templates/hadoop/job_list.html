{% extends "hadoop/index.html" %}
{% block content %}
<div class="top-div">
    <div class="search-box">
        <input type="hidden" id="customer_value" value="0">
        <input type="hidden" id="channel_value" value="0">
        <div class="search">
            <input id="customer" class="text" type="text"
                   value="客户查询" onfocus="searchFocusSet(this,'客户查询')" onblur="searchBlurSet(this,'客户查询')"
                   autocomplete="off" role="textbox" aria-autocomplete="list" aira-haspopup="true">
        </div>
        <div class="search">
            <input id="channel" class="text" type="text"
                   value="频道查询" onfocus="searchFocusSet(this,'频道查询')" onblur="searchBlurSet(this,'频道查询')"
                   autocomplete="off" role="textbox" aria-autocomplete="list" aira-haspopup="true">
        </div>
        <div class="boxPriority search">
            <select id="s_priority" class="hyjack" autocomplete="off">
                <option value="-1">请选择优先级</option>
                <option value="0">P0</option>
                <option value="1">P1</option>
                <option value="2">P2</option>
                <option value="3">P3</option>
                <option value="4">P4</option>
                <option value="5">P5</option>
            </select>
        </div>
        <div class="boxStatus search">
            <select id="s_status" class="hyjack" autocomplete="off">
                <option value="-1">请选择任务状态</option>
                {% for key,value in status.items %}
                    <option value="{{ key }}">{{ value|capfirst }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="search">
            <input type="text" id="beginDate" class="datepicker" value="{{ beginDate }}" readonly="true" name="beginDate"/>
            <input type="hidden" id="current_page" name="current_page"/>
            <input type="hidden" id="total_page" name="total_page"/>
            <a class="popup" href="/hadoop/job/action/failed/"></a>
        </div>
        <div class="search submit">
            <input type="image" src="/static/images/btn_submit.png" id="submit"/>
        </div>
    </div>
    <div class="clear"></div>
</div>
<div class="middle-div">
    <div id="summary-total" class="drop-shadow curved curved-vt-2">
        <div class="section-head">
            <div class="section">
                <p class="title">预计发布</p>
                <p class="value">{{ source_size }}</p>
            </div>
            <div class="section">
                <p class="title">已经发布</p>
                <p class="value">{{ target_size }}</p>
            </div>
            <div class="clear"></div>
        </div>
        <div class="section-body">
            <div class="section" style="width: 20%;">
                <p class="title">总任务数</p>
                <p class="value">{{ all_tasks }}</p>
            </div>
            <div class="section" style="width: 20%;">
                <p class="title">排队中任务</p>
                <p class="value">{{ waiting_tasks }}</p>
            </div>
            <div class="section" style="width: 20%;">
                <p class="title">成功任务</p>
                <p class="value">{{ success_tasks }}</p>
            </div>
            <div class="section" style="width: 20%;">
                <p class="title">失败任务</p>
                <p class="value">{{ failed_tasks }}</p>
            </div>
            <div class="section" style="width: 20%;">
                <p class="title">进行中任务</p>
                <p class="value">{{ doing_tasks }}</p>
            </div>
            <div class="clear"></div>
        </div>
    </div>
    <div id="div-split" class='clear'></div>
</div>
<script type="text/javascript">
$(document).ready(function() {
    $('.datepicker').datepicker();

    $('a.popup').fancybox({
        'width': "280",
        'height': "68",
        'autoScale': true,
        'centerOnScroll': true,
        'padding': 28,
        'margin': 48,
        'scrolling': "no",
        'overlayOpacity': 0.4,
        'overlayColor': "#979b8f",
        'transitionIn': "elastic",
        'transitionOut': "elastic",
        'enableEscapeButton': true
    });

    $('div.search input.text').addClass('search_font_style');
    $('#customer').autocomplete({
          source: function(request, response) {
              $.ajax({
                 url: "/rcms/customers/",
                 dataType: "json",
                 data: {
                     name: request.term
                 },
                 success: function(data) {
                     response($.map(data.customers, function(item) {
                         return {
                             label: item.name,
                             value: item.customerId
                         }
                     }));
                 }
             });
          },
          minLength: 2,
          focus: function(event, ui) {
              $('#customer').val(ui.item.label);
              return false;
          },
          select: function(event, ui) {
              $('#customer').val(ui.item.label);
              $('#customer_value').val(ui.item.value);
              return false;
          },
          change: function(event, ui) {
              if (ui.item) {
                  $('#customer_value').val(ui.item.value);
              }
              else {
                  $('#customer_value').val("0");
              }
              return false;
          }
      });

    $('#channel').autocomplete({
        source: function(request, response) {
            $.ajax({
               url: "/rcms/channels/",
               dataType: "json",
               data: {
                   name: request.term
               },
               success: function(data) {
                   response($.map(data.channels, function(item) {
                       return {
                           label: item.name,
                           value: item.channelId
                       }
                   }));
               }
           });
        },
        minLength: 5,
        focus: function(event, ui) {
            $('#channel').val(ui.item.label);
            return false;
        },
        select: function(event, ui) {
            $('#channel').val(ui.item.label);
            $('#channel_value').val(ui.item.value);
            return false;
        },
        change: function(event, ui) {
            if (ui.item) {
                $('#channel_value').val(ui.item.value);
            }
            else {
                $('#channel_value').val("0");
            }
            return false;
        }
    });

    $('#s_priority').hyjack_select({
        ddImage: '/static/images/arrow_down.png',
        ddCancel: '/static/images/cancel.png',
        emptyMessage: 'No item'
    });
    $('div.boxPriority div.hjsel_container').css("width", "130px");
    $('div.boxPriority div div input[type="text"]').css("width", "96px");

    $('#s_status').hyjack_select({
        ddImage: '/static/images/arrow_down.png',
        ddCancel: '/static/images/cancel.png',
        emptyMessage: 'No item'
    });
    $('div.boxStatus div.hjsel_container').css("width", "130px");
    $('div.boxStatus div div input[type="text"]').css("width", "96px");

    $('#submit').click(function() {
        var customerId = $('#customer_value').val();
        var channelId = $('#channel_value').val();
        var priority = $('#s_priority option:selected').val();
        var status = $('#s_status option:selected').val();
        var day = $('#beginDate').val();

        if (customerId == "0" && channelId == "0" && priority == "-1" && status == "-1") {
            $.ajax({
                type: "GET",
                url: "/hadoop/job/?beginDate="+day,
                success: function(data) {
                    $("#contents").html(data);
                }
            });
        }
        else {
            var args = {"beginDate": day, "customerId": customerId, "channelId": channelId, "priority": priority, "status": status};
            $.getJSON("/hadoop/job/detail/list/",
                args,
                function(data) {
                    $('#current_page').val(1);
                    if (data["all_tasks"]%10 != 0) {
                        $('#total_page').val(Math.floor(data["all_tasks"]/10 + 1));
                    }
                    else {
                        $('#total_page').val(Math.floor(data["all_tasks"]/10));
                    }
                    $('div#summary-total').remove();
                    var summary = "<div id='summary-total' style='height: 80px;' class='drop-shadow curved curved-vt-2'>"
                                    + "<div class='section-body' style='height: 80px;'>"
                                        + "<div class='section' style='height: 80px; width: 40%'><p class='title' style='margin-top: 8px;'>发布大小</p>"
                                        + "<p class='value'>"+data["publish_size"]+"</p>"
                                        + "</div>"
                                        + "<div class='section' style='height: 80px;'><p class='title' style='margin-top: 8px;'>排队中任务</p>"
                                        + "<p class='value'>"+data["waiting_tasks"]+"</p>"
                                        + "</div>"
                                        + "<div class='section' style='height: 80px;'><p class='title' style='margin-top: 8px;'>成功任务</p>"
                                        + "<p class='value'>"+data["success_tasks"]+"</p>"
                                        + "</div>"
                                        + "<div class='section' style='height: 80px;'><p class='title' style='margin-top: 8px;'>失败任务</p>"
                                        + "<p class='value'>"+data["failed_tasks"]+"</p>"
                                        + "</div>"
                                        + "<div class='section' style='height: 80px;'><p class='title' style='margin-top: 8px;'>进行中任务</p>"
                                        + "<p class='value'>"+data["doing_tasks"]+"</p>"
                                        + "</div>"
                                    + "</div>"
                                + "</div>";
                    $('div.middle-div').prepend(summary);

                    $('div.div-table').remove();
                    var table = "<div class='div-table'>";
                    table += "<div class='div-head'>"
                                +"<div class='div-th' style='width: 32%'>频道</div>"
                                +"<div class='div-th' style='width: 6%'>优先级</div>"
                                +"<div class='div-th' style='width: 10%'>状态</div>"
                                +"<div class='div-th' style='width: 12%'>源日志大小</div>"
                                +"<div class='div-th' style='width: 12%'>发布日志大小</div>"
                                +"<div class='div-th' style='width: 16%'>最后更新时间</div>"
                                +"<div class='div-th' style='width: 12%'>操作</div>"
                                +"<div class='clear'></div>"
                            +"</div>";
                    $.each(data["data"], function(index, entry) {
                        table += "<div class='div-tr level0' id='tr"+index+"'>";
                        if (entry["status"] == "successful") {
                            table += "<div class='div-td' style='width: 32%'><a class='tooltip' title='"+entry["dbId"]+"' href='"+entry["url"]+"'>"+entry["channel_name"]+"</a></div>";
                        }
                        else {
                            table += "<div class='div-td' style='width: 32%'><a class='tooltip' title='"+entry["dbId"]+"'>"+entry["channel_name"]+"</a></div>";
                        }
                        table += "<div class='div-td task_priority' style='width: 6%'>"+entry["priority"]+"</div>";
                        if (entry["status"] != "sleep") {
                            table += "<div class='div-td task_status' style='width: 10%'><a target='_blank' href='"+entry["job_url"]+"'>"+entry["status"]+"</a></div>";
                        }
                        else {
                            table += "<div class='div-td task_status' style='width: 10%'>"+entry["status"]+"</div>";
                        }
                        table += "<div class='div-td' style='width: 12%'><a class='tooltip' title='"+entry["source_fline"]+"'>"+entry["source_fsize"]+"</a></div>";
                        table += "<div class='div-td' style='width: 12%'><a href='/hadoop/publish/"+entry["channel_id"]+"/' class='tooltip pubsize' title='"+entry["target_fline"]+"'>"+entry["target_fsize"]+"</a></div>";
                        table += "<div class='div-td' style='width: 16%'>"+entry["update_time"]+"</div>";
                        table += "<div class='div-td task_action' style='width: 12%' id='"+entry["dbId"]+"'>";
                        if (entry["status"] == "sleep") {
                            table += "<span class='button levelup end'></span>"
                                    +"<span class='button "+entry["action"]+"'></span>";
                        }
                        else {
                            table += "<span class='button "+entry["action"]+"' style='float: none; margin: auto;'></span>";
                        }
                            table += "<div class='clear'></div>"
                                +"</div>";
                        table += "</div><div class='clear'></div>";
                    });
                    table += "</div>";
                    $('div.middle-div div#div-split').after(table);

                    if (Number($('#total_page').val()) > 1) {
                        $('div.paginate').remove();
                        var page = "<div class='paginate'>"
                                        +"<span class='button last'></span>"
                                        +"<span class='button play'></span>"
                                        +"<span class='button previous'></span>"
                                        +"<span class='button first'></span>"
                                        +"<span id='tp' class='page_info page_info_end'>"+$('#total_page').val()+"</span>"
                                        +"<span class='page_info'>/</span>"
                                        +"<span id='cp' class='page_info'>"+$('#current_page').val()+"</span>"
                                        +"<div class='clear'></div>"
                                  +"</div>";
                        $('div.div-table').after(page);
                        loadPaginate(1);
                        bindPageAction();
                    }
                    else {
                        $('div.paginate').remove();
                    }
                    bindTaskAction();
                    $('a.tooltip').tipTip({maxWidth: "auto", defaultPosition: "top"});
                }
            );
        }
    });
});

function loadPaginate(page) {
    $('div.div-tr').hide();
    
    for(var i=page*10-10;i<page*10;i++) {
        $('div#tr'+i).show();
    }
}

function bindTaskAction() {
    $('div.div-td span.button').click(function() {
        var button = $(this);
        var dbId = button.parent().attr("id");
        var action = "";
        if ($(this).hasClass("play")) {
            action = "start";
        }
        else if ($(this).hasClass("stop")) {
            action = "kill";
        }
        else {
            action = "levelup";
        }

        $.getJSON("/hadoop/job/action",
            {"dbId": dbId, "action": action},
            function(data) {
                if (data["result"] == 1) {
                    var html;
                    if (data["action"] == "start") {
                        button.parent().parent().children(".task_status").text("waiting");
                        html = "<span class='button stop' style='float: none; margin: auto;'></span><div class='clear'></div>";
                        button.parent().parent().children(".task_action").html(html);
                    }
                    else if (data["action"] == "kill") {
                        button.parent().parent().children(".task_status").text("sleep");
                        html = "<span class='button levelup end'></span>"
                              +"<span class='button play'></span>"
                              +"<div class='clear'></div>";
                        button.parent().parent().children(".task_action").html(html);
                    }
                    else if (data["action"] == "levelup") {
                        button.parent().parent().children(".task_priority").text("0");
                    }
                    bindTaskAction();
                }
                else {
                    $('a.popup').click();
                }
            }
        )
    });

    $('a.pubsize').fancybox({
       'width': "800",
       'height': "500",
       'autoScale': true,
       'centerOnScroll': true,
       'padding': 28,
       'margin': 48,
       'scrolling': 'no',
       'overlayOpacity': 0.4,
       'overlayColor': "#979b8f",
       'transitionIn': "elastic",
       'transitionOut': "elastic",
       'enableEscapeButton': true
   });
}

function bindPageAction() {
    var total_page = Number($('#total_page').val());
    
    $('div.paginate span.play').click(function() {
        var current_page = Number($('#current_page').val());
        if (current_page < total_page) {
            loadPaginate(current_page+1);
            $('#current_page').val(current_page+1);
        }
        $('span#cp').text($('#current_page').val());
    });
    $('div.paginate span.previous').click(function() {
        var current_page = Number($('#current_page').val());
        if (current_page > 1) {
            loadPaginate(current_page-1);
            $('#current_page').val(current_page-1);
        }
        $('span#cp').text($('#current_page').val());
    });
    $('div.paginate span.last').click(function() {
        $('span#cp').text(total_page);
        loadPaginate(total_page);
        $('#current_page').val(total_page);
    });
    $('div.paginate span.first').click(function() {
        $('span#cp').text(1);
        loadPaginate(1);
        $('#current_page').val(1);
    });
}
</script>
{% endblock %}